<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interactive Blackboard Math Animation (W3.CSS)</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Patrick Hand', cursive; }
    .board {
      font-size: 28px;
      line-height: 1.4;
      padding: 40px;
      overflow-y: auto;
      height: 75vh;            /* 75% of screen height */
      border-radius: 25px;     /* rounded corners */
    }
    .chalk { text-shadow: 0 0 2px #ddd, 0 0 4px rgba(255,255,255,0.1); text-align: left; white-space: pre-wrap; }
    .numeric { text-align: right; }
    .cursor { display:inline-block; width:10px; animation:blink 0.9s step-end infinite; height:1em; vertical-align:bottom; margin-left:3px; }
    @keyframes blink { 50% { opacity:0; } }
    .line { border-bottom:3px solid currentColor; margin:8px 0; width:100%; }

    /* Board color squares */
    .color-box {
      width:30px; height:30px; cursor:pointer; display:inline-block; margin-right:8px;
      border:2px solid #ccc; /* square: no border-radius */
    }

    /* Text color circles */
    .color-circle {
      width:30px; height:30px; cursor:pointer; display:inline-block; margin-right:8px;
      border:2px solid #ccc; border-radius:50%;
    }

    .selected { border:3px solid orange !important; }

    /* Text color circle fills */
    .color-circle.red { background:red; }
    .color-circle.blue { background:blue; }
    .color-circle.green { background:green; }
    .color-circle.yellow { background:yellow; }
    .color-circle.purple { background:purple; }
    .color-circle.white { background:white; }
  </style>
</head>
<body class="w3-gray">

<!-- Top bar: board colors left, speed slider right -->
<div class="w3-container w3-center w3-padding">
  <div class="w3-row" style="width:75%; margin:auto;">
    <div class="w3-col s6" style="text-align:left;">
      <span class="color-box w3-white" onclick="setBoardColor('white', this)"></span>
      <span class="color-box w3-black" onclick="setBoardColor('black', this)"></span>
      <span class="color-box w3-gray" onclick="setBoardColor('gray', this)"></span>
      <span class="color-box w3-green" onclick="setBoardColor('green', this)"></span>
      <span class="color-box w3-blue" onclick="setBoardColor('blue', this)"></span>
    </div>
    <div class="w3-col s6" style="text-align:right;">
      <label for="speed" class="w3-text-light-gray" style="margin-right:10px;">Speed</label>
      <input id="speed" type="range" min="20" max="600" value="120">
    </div>
  </div>
</div>

<!-- Board -->
<div class="w3-container w3-center">
  <div class="w3-card w3-round-xlarge" style="width:75%; margin:auto;" id="stage">
    <div class="board w3-black w3-text-white" id="board"></div>
  </div>
</div>

<!-- Input + text color circles -->
<div class="w3-container w3-center w3-padding">
  <div style="width:75%; margin:auto; text-align:left;">
    <input id="equationInput" class="w3-input w3-black w3-text-white" 
           placeholder="Type equation (use <red>...</red>) and press Enter...">
    <div class="w3-margin-top">
      <span class="color-circle red" onclick="setTextColor('red', this)"></span>
      <span class="color-circle blue" onclick="setTextColor('blue', this)"></span>
      <span class="color-circle green" onclick="setTextColor('green', this)"></span>
      <span class="color-circle yellow" onclick="setTextColor('yellow', this)"></span>
      <span class="color-circle purple" onclick="setTextColor('purple', this)"></span>
      <span class="color-circle white" onclick="setTextColor('white', this)"></span>
    </div>
  </div>
</div>

<script>
  // Superscripts
  const superscripts = { "0":"⁰","1":"¹","2":"²","3":"³","4":"⁴","5":"⁵","6":"⁶","7":"⁷","8":"⁸","9":"⁹","a":"ᵃ","b":"ᵇ","n":"ⁿ" };
  function formatSuperscripts(text){ return text.replace(/\^([0-9a-zA-Z])/g,(_,c)=>superscripts[c]||c); }

  // Inline color tags: <red>...</red> -> <span data-color="red">...</span>
  function parseColoredText(text){
    return text.replace(/<(\w+)>(.*?)<\/\1>/g,(m,color,content)=>`<span data-color="${color}">${content}</span>`);
  }

  const board=document.getElementById("board");
  const inputBox=document.getElementById("equationInput");
  const speedInput=document.getElementById("speed");

  let charDelay=parseInt(speedInput.value,10);
  let animating=false;
  let currentTextColor="red"; // default chalk color

  speedInput.addEventListener("input",()=>{ charDelay=parseInt(speedInput.value,10); });

  inputBox.addEventListener("keydown",async e=>{
    if(e.key==="Enter"&&inputBox.value.trim()!==""&&!animating){
      const rawText=inputBox.value.trim(); inputBox.value="";
      if(rawText.toLowerCase()==="line"){ drawLine(); }
      else if(rawText.toLowerCase()==="clear"){ clearBoard(); }
      else{ await animateLine(rawText); }
    }
  });

  async function animateLine(lineText){
    animating=true;
    const formattedLine=formatSuperscripts(lineText);
    const parsedLine=parseColoredText(formattedLine);
    const isNumeric=/^[+\-×]?\d+$/.test(lineText);

    const line=document.createElement("div");
    line.className="chalk"+(isNumeric?" numeric":"");
    line.style.color=currentTextColor; // default line color when no tags
    const textSpan=document.createElement("span");
    const cursor=document.createElement("span");
    cursor.className="cursor"; cursor.style.background=currentTextColor;
    line.appendChild(textSpan); line.appendChild(cursor); board.appendChild(line);

    // Animate parsed content without duplicates
    const tempDiv=document.createElement("div"); tempDiv.innerHTML=parsedLine;
    for(const node of tempDiv.childNodes){
      if(node.nodeType===Node.TEXT_NODE){
        for(const ch of node.textContent){ textSpan.append(ch); await wait(charDelay); }
      } else if(node.nodeType===Node.ELEMENT_NODE){
        const color=node.getAttribute("data-color")||currentTextColor;
        for(const ch of node.textContent){
          const s=document.createElement("span"); s.style.color=color; s.textContent=ch;
          textSpan.appendChild(s); await wait(charDelay);
        }
      }
    }

    cursor.remove();
    animating=false;
    scrollToBottom();   // always show the latest line
  }

  function drawLine(){
    const line=document.createElement("div");
    line.className="line";
    board.appendChild(line);
    scrollToBottom();
  }

  function clearBoard(){
    board.innerHTML="";
    scrollToBottom();
  }

  function wait(ms){ return new Promise(res=>setTimeout(res,ms)); }

  function scrollToBottom(){
    board.scrollTop = board.scrollHeight;
  }

  // Board color switcher with background + selected highlight
  function setBoardColor(color,el){
    document.querySelectorAll(".color-box").forEach(c=>c.classList.remove("selected"));
    if(el) el.classList.add("selected");

    board.className="board w3-"+color;
    if(["white","gray","blue"].includes(color)){
      board.classList.add("w3-text-black");
      document.body.className="w3-light-gray";
    } else if(color==="black"){
      board.classList.add("w3-text-white");
      document.body.className="w3-gray";
    } else {
      board.classList.add("w3-text-white");
      document.body.className="w3-black";
    }
  }

  // Text color switcher with selected highlight
  function setTextColor(color,el){
    currentTextColor=color;
    document.querySelectorAll(".color-circle").forEach(c=>c.classList.remove("selected"));
    if(el) el.classList.add("selected");
  }

  // Defaults on load: black board + gray background, red chalk, highlights set
  window.onload=()=>{
    setBoardColor("black",document.querySelector(".color-box.w3-black"));
    setTextColor("red",document.querySelector(".color-circle.red"));
  };
</script>
</body>
</html>
